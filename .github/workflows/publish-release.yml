name: publish-release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: Swatinem/rust-cache@v1
    - name: Build
      run: cargo build -v
    - name: Run tests
      run: cargo test -v
  create-release:
    runs-on: ubuntu-latest
    needs: test
    outputs:
      created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
    - uses: actions/checkout@v3
    - name: Create a new release
      id: release
      uses: google-github-actions/release-please-action@v3.1
      with:
        release-type: rust
  publish-crate:
    runs-on: ubuntu-latest
    needs: create-release
    steps:
    - uses: actions/checkout@v3
    - uses: Swatinem/rust-cache@v1
    - name: Publish new version of the crate to crates.io
      run: cargo publish
  linux:
    runs-on: ubuntu-latest
    needs: create-release
    steps:
    - uses: actions/checkout@v3
    - uses: Swatinem/rust-cache@v1
    - name: Install dependencies
      run: |
        sudo apt install \
          libchromaprint-dev \
          libavutil-dev \
          libavformat-dev \
          libswresample-dev \
          libavcodec-dev \
          libavfilter-dev \
          libavdevice-dev
    - name: Build release version
      run: cargo build -v --release
    - name: Compress binary
      run: cd target/release && tar cvzf needle-{{ needs.create-release.outputs.tag_name }}-linux-amd64.tar.gz needle
    - name: Upload binary to the release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: target/release/*.tar.gz
  macos:
    runs-on: macos-latest
    needs: create-release
    steps:
    - uses: actions/checkout@v3
    - uses: Swatinem/rust-cache@v1
    - name: Install dependencies
      run: brew install ffmpeg chromaprint
    - name: Build release version
      run: cargo build -v --release
    - name: Create a new release
      id: release
      uses: google-github-actions/release-please-action@v3.1
      with:
        release-type: rust
    - name: Compress binary
      run: cd target/release && tar cvzf needle-{{ needs.create-release.outputs.tag_name }}-macos-amd64.tar.gz needle
    - name: Upload binary to the release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: target/release/*.tar.gz
  windows:
    runs-on: windows-latest
    needs: create-release
    env:
      VCPKG_ROOT: ${{ github.workspace }}/vcpkg
      VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg/bincache
    steps:
    - uses: actions/checkout@v3
    - uses: Swatinem/rust-cache@v1
    - name: "Create directory '${{ env.VCPKG_DEFAULT_BINARY_CACHE }}'"
      run: mkdir -p $VCPKG_DEFAULT_BINARY_CACHE
      shell: bash
    - name: Install cargo-vcpkg
      run: cargo install cargo-vcpkg
    # Restore both vcpkg and its artifacts from the GH cache service.
    # Taken from here: https://github.com/lukka/CppCMakeVcpkgTemplate/blob/main/.github/workflows/hosted-pure-workflow.yml
    - name: Restore vcpkg and its artifacts.
      uses: actions/cache@v2
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          !${{ env.VCPKG_ROOT }}/buildtrees
          !${{ env.VCPKG_ROOT }}/packages
          !${{ env.VCPKG_ROOT }}/downloads
          !${{ env.VCPKG_ROOT }}/installed
        key: ${{ hashFiles( 'Cargo.lock' ) }}
    - name: Install dependencies
      run: cargo vcpkg build --target x64-windows-static-md
    - name: Build release version
      run: cargo build -v --release
    - name: Create a new release
      id: release
      uses: google-github-actions/release-please-action@v3.1
      with:
        release-type: rust
    - name: Compress binary
      run: cd target/release && tar cvzf needle-{{ needs.create-release.outputs.tag_name }}-windows-amd64.tar.gz needle
      shell: bash
    - name: Upload binary to the release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag_name }}
        files: target/release/*.tar.gz
